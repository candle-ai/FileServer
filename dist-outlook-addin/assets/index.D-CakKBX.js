var ye=Object.defineProperty;var we=(t,e,o)=>e in t?ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var h=(t,e,o)=>we(t,typeof e!="symbol"?e+"":e,o);import{H as C,n as P,i as Se,c as Oe,d as ie,e as Ae,S as z,m as ve,f as Fe,g as Ee,h as ae,j as Pe,B as Ie,E as be,r as Te,t as _e,k as Re,p as Ce,N as De,l as xe,o as Le,q as Ue,s as Me,u as Ne,v as $e,D as He,F as ze,w as Ge,x as We,y as je,z as Be,G as Ve,J as qe,K as Ke,M as Je,O as Xe,P as Ye,Q as Ze,R as Qe,T as et,U as tt,V as ot,W as rt,X as st,Y as nt,Z as it,_ as at,L as ct}from"./taskpane.js";import"./modulepreload-polyfill.B5Qt9EMX.js";class ut{constructor(e){h(this,"logger");h(this,"sessionData",new Map);h(this,"onChanged");h(this,"removeChangeListener");this.logger=e}async getSessionItem(e){try{if(typeof sessionStorage<"u"){const o=sessionStorage.getItem(e);if(o)return JSON.parse(o)}else{const o=this.sessionData.get(e);return o!==void 0?o:null}return null}catch(o){return this.logger.error(`Error retrieving session item with key: ${e}`,o,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getSessionItem"}),null}}async setSessionItem(e,o){try{typeof sessionStorage<"u"?sessionStorage.setItem(e,JSON.stringify(o)):this.sessionData.set(e,o),this.logger.debug(`Stored session item with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"setSessionItem"})}catch(r){throw this.logger.error(`Error storing session item with key: ${e}`,r,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"setSessionItem"}),r}}async removeSessionItem(e){try{typeof sessionStorage<"u"?sessionStorage.removeItem(e):this.sessionData.delete(e),this.logger.debug(`Removed session item with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"removeSessionItem"})}catch(o){throw this.logger.error(`Error removing session item with key: ${e}`,o,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"removeSessionItem"}),o}}async clearSession(){try{typeof sessionStorage<"u"?sessionStorage.clear():this.sessionData.clear(),this.logger.info("Cleared session storage",{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"clearSession"})}catch(e){throw this.logger.error("Error clearing session storage",e,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"clearSession"}),e}}async getLocalItem(e){var o;try{if(typeof localStorage<"u"){const r=localStorage.getItem(e);if(r){const s=JSON.parse(r);return this.logger.debug(`Retrieved local item with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getLocalItem"}),s}}else if((o=Office==null?void 0:Office.context)!=null&&o.roamingSettings){const r=Office.context.roamingSettings.get(e);if(r){const s=JSON.parse(r);return this.logger.debug(`Retrieved item from roaming settings with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getLocalItem"}),s}}return null}catch(r){return this.logger.error(`Error retrieving local item with key: ${e}`,r,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getLocalItem"}),null}}async setLocalItem(e,o){var r;try{if(typeof localStorage<"u")localStorage.setItem(e,JSON.stringify(o)),this.logger.debug(`Stored local item with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"setLocalItem"});else if((r=Office==null?void 0:Office.context)!=null&&r.roamingSettings)Office.context.roamingSettings.set(e,JSON.stringify(o)),await new Promise((s,i)=>{Office.context.roamingSettings.saveAsync(a=>{var n;a.status===Office.AsyncResultStatus.Succeeded?(this.logger.debug(`Stored item in roaming settings with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"setLocalItem"}),s()):i(new Error(((n=a.error)==null?void 0:n.message)||"Failed to save roaming settings"))})});else throw new Error("No storage mechanism available")}catch(s){throw this.logger.error(`Error storing local item with key: ${e}`,s,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"setLocalItem"}),s}}async removeLocalItem(e){var o;try{if(typeof localStorage<"u")localStorage.removeItem(e),this.logger.debug(`Removed local item with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"removeLocalItem"});else if((o=Office==null?void 0:Office.context)!=null&&o.roamingSettings)Office.context.roamingSettings.remove(e),await new Promise((r,s)=>{Office.context.roamingSettings.saveAsync(i=>{var a;i.status===Office.AsyncResultStatus.Succeeded?(this.logger.debug(`Removed item from roaming settings with key: ${e}`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"removeLocalItem"}),r()):s(new Error(((a=i.error)==null?void 0:a.message)||"Failed to save roaming settings"))})});else throw new Error("No storage mechanism available")}catch(r){throw this.logger.error(`Error removing local item with key: ${e}`,r,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"removeLocalItem"}),r}}async clearLocal(){var e;try{if(typeof localStorage<"u")localStorage.clear(),this.logger.info("Cleared local storage",{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"clearLocal"});else if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const o=await this.getAllKeys();for(const r of o)Office.context.roamingSettings.remove(r);await new Promise((r,s)=>{Office.context.roamingSettings.saveAsync(i=>{var a;i.status===Office.AsyncResultStatus.Succeeded?(this.logger.info("Cleared all roaming settings",{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"clearLocal"}),r()):s(new Error(((a=i.error)==null?void 0:a.message)||"Failed to save roaming settings"))})})}else throw new Error("No storage mechanism available")}catch(o){throw this.logger.error("Error clearing local storage",o,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"clearLocal"}),o}}async getSyncItem(e){return this.getLocalItem(e)}async setSyncItem(e,o){return this.setLocalItem(e,o)}async removeSyncItem(e){return this.removeLocalItem(e)}async clearSync(){return this.clearLocal()}async setItem(e,o){return this.setLocalItem(e,o)}async getItem(e){return this.getLocalItem(e)}async removeItem(e){return this.removeLocalItem(e)}async clear(){return this.clearLocal()}async getAllKeys(){var e;try{if(typeof localStorage<"u"){const o=Object.keys(localStorage);return this.logger.debug(`Retrieved ${o.length} keys from storage`,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getAllKeys"}),o}else if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings)return this.logger.warn("getAllKeys not fully supported with Office roaming settings",{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getAllKeys"}),[];return[]}catch(o){return this.logger.error("Error getting all keys",o,{sourceFile:"src/platforms/outlook/OutlookStorageProvider.ts",sourceFunction:"getAllKeys"}),[]}}}class lt{constructor(e){h(this,"logger");h(this,"threadListeners",new Set);h(this,"currentThread",null);h(this,"isInitialized",!1);this.logger=e,this.initializeOutlookListeners()}initializeOutlookListeners(){var e,o;(o=(e=Office==null?void 0:Office.context)==null?void 0:e.mailbox)!=null&&o.addHandlerAsync&&Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged,this.handleItemChanged.bind(this))}async handleItemChanged(){var e;try{const o=await this.getCurrentThread();(o==null?void 0:o.threadId)!==((e=this.currentThread)==null?void 0:e.threadId)&&(this.currentThread=o,this.notifyThreadListeners(o))}catch(o){this.logger.error("Error handling item change",o,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"handleItemChanged"})}}async getCurrentThread(){return new Promise(e=>{var o,r;if(!((r=(o=Office==null?void 0:Office.context)==null?void 0:o.mailbox)!=null&&r.item)){e(null);return}try{const s=Office.context.mailbox.item;if(s.getConversationIndexAsync)s.getConversationIndexAsync(i=>{if(i.status===Office.AsyncResultStatus.Succeeded){const a=i.value;this.getItemDetails(s,a).then(n=>e(n)).catch(n=>{this.logger.error("Error getting item details",n,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getCurrentThread"}),e(null)})}else this.logger.error("Error getting conversation index",i.error,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getCurrentThread"}),e(null)});else{const i=s.itemId||"unknown";this.getItemDetails(s,i).then(a=>e(a)).catch(a=>{this.logger.error("Error getting item details (fallback)",a,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getCurrentThread"}),e(null)})}}catch(s){this.logger.error("Error in getCurrentThread",s,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getCurrentThread"}),e(null)}})}async getCurrentThreadId(){return new Promise(e=>{var r,s;if(!((s=(r=Office==null?void 0:Office.context)==null?void 0:r.mailbox)!=null&&s.item)){e(null);return}const o=Office.context.mailbox.item;o.getConversationIndexAsync?o.getConversationIndexAsync(i=>{i.status===Office.AsyncResultStatus.Succeeded?e(i.value):(this.logger.error("Error getting conversation index",i.error,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getCurrentThreadId"}),e(o.itemId||null))}):e(o.itemId||null)})}onThreadChanged(e){this.threadListeners.add(e)}removeThreadListener(e){this.threadListeners.delete(e)}notifyThreadListeners(e){this.threadListeners.forEach(o=>{try{o(e)}catch(r){this.logger.error("Error in thread change callback",r,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"notifyThreadListeners"})}})}async getItemDetails(e,o){return new Promise(async r=>{try{const s=e,i=s.subject||"No Subject";let a=this.extractParticipants(s);try{const c=await this.extractAsyncParticipants(s),u=new Set([...a,...c]);a=Array.from(u)}catch(c){this.logger.warn("Could not extract async participants",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getItemDetails",error:c})}const n={from:this.getFromAddress(s),timestamp:this.getTimestamp(s),subject:i,body:"",html:""};s.body&&s.body.getAsync?s.body.getAsync(Office.CoercionType.Html,c=>{c.status===Office.AsyncResultStatus.Succeeded&&(n.html=c.value,n.body=this.stripHtml(c.value)),r({threadId:o,messages:[n],subject:i,participants:a})}):r({threadId:o,messages:[n],subject:i,participants:a})}catch(s){this.logger.error("Error getting item details",s,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getItemDetails",threadId:o}),r(null)}})}extractParticipants(e){const o=new Set;try{const r=this.getFromAddress(e);r&&r!=="Unknown"&&o.add(r),e.sender&&e.sender.emailAddress&&o.add(e.sender.emailAddress),e.to&&Array.isArray(e.to)&&e.to.forEach(s=>{s.emailAddress&&o.add(s.emailAddress)}),e.cc&&Array.isArray(e.cc)&&e.cc.forEach(s=>{s.emailAddress&&o.add(s.emailAddress)}),e.bcc&&Array.isArray(e.bcc)&&e.bcc.forEach(s=>{s.emailAddress&&o.add(s.emailAddress)})}catch(r){this.logger.warn("Error extracting participants",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"extractParticipants",error:r})}return Array.from(o)}async extractAsyncParticipants(e){const o=new Set;try{const r=[];e.to&&typeof e.to.getAsync=="function"&&r.push(this.getRecipientsAsync(e.to,"to")),e.cc&&typeof e.cc.getAsync=="function"&&r.push(this.getRecipientsAsync(e.cc,"cc")),e.bcc&&typeof e.bcc.getAsync=="function"&&r.push(this.getRecipientsAsync(e.bcc,"bcc")),(await Promise.allSettled(r)).forEach(i=>{i.status==="fulfilled"&&i.value.forEach(a=>o.add(a))})}catch(r){this.logger.warn("Error extracting async participants",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"extractAsyncParticipants",error:r})}return Array.from(o)}getRecipientsAsync(e,o){return new Promise(r=>{e.getAsync(s=>{if(s.status===Office.AsyncResultStatus.Succeeded){const i=s.value.map(a=>a.emailAddress).filter(a=>a);r(i)}else this.logger.warn(`Error getting ${o} recipients`,{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getRecipientsAsync",error:s.error}),r([])})})}getFromAddress(e){try{return e.from&&e.from.emailAddress?e.from.emailAddress:e.sender&&e.sender.emailAddress?e.sender.emailAddress:"Unknown"}catch(o){return this.logger.warn("Error getting from address",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getFromAddress",error:o}),"Unknown"}}getTimestamp(e){try{return e.dateTimeCreated?e.dateTimeCreated.toISOString():e.dateTimeModified?e.dateTimeModified.toISOString():new Date().toISOString()}catch(o){return this.logger.warn("Error getting timestamp",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"getTimestamp",error:o}),new Date().toISOString()}}stripHtml(e){try{return e.replace(/<[^>]*>/g,"").trim()}catch(o){return this.logger.warn("Error stripping HTML",{sourceFile:"src/platforms/outlook/OutlookDataProvider.ts",sourceFunction:"stripHtml",error:o}),e}}}const dt=t=>e=>async o=>{if(!C.isInstance(o.request))return e(o);const{request:r}=o,{handlerProtocol:s=""}=t.requestHandler.metadata||{};if(s.indexOf("h2")>=0&&!r.headers[":authority"])delete r.headers.host,r.headers[":authority"]=r.hostname+(r.port?":"+r.port:"");else if(!r.headers.host){let i=r.hostname;r.port!=null&&(i+=`:${r.port}`),r.headers.host=i}return e(o)},gt={name:"hostHeaderMiddleware",step:"build",priority:"low",tags:["HOST"],override:!0},ht=t=>({applyToStack:e=>{e.add(dt(t),gt)}}),ft=()=>(t,e)=>async o=>{var r,s;try{const i=await t(o),{clientName:a,commandName:n,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l,overrideOutputFilterSensitiveLog:d}=u,g=l??e.inputFilterSensitiveLog,f=d??e.outputFilterSensitiveLog,{$metadata:O,...T}=i.output;return(r=c==null?void 0:c.info)==null||r.call(c,{clientName:a,commandName:n,input:g(o.input),output:f(T),metadata:O}),i}catch(i){const{clientName:a,commandName:n,logger:c,dynamoDbDocumentClientOptions:u={}}=e,{overrideInputFilterSensitiveLog:l}=u,d=l??e.inputFilterSensitiveLog;throw(s=c==null?void 0:c.error)==null||s.call(c,{clientName:a,commandName:n,input:d(o.input),error:i,metadata:i.$metadata}),i}},pt={name:"loggerMiddleware",tags:["LOGGER"],step:"initialize",override:!0},mt=t=>({applyToStack:e=>{e.add(ft(),pt)}});var G={};const D="X-Amzn-Trace-Id",kt="AWS_LAMBDA_FUNCTION_NAME",yt="_X_AMZN_TRACE_ID",wt=t=>e=>async o=>{const{request:r}=o;if(!C.isInstance(r)||t.runtime!=="node")return e(o);const s=Object.keys(r.headers??{}).find(c=>c.toLowerCase()===D.toLowerCase())??D;if(r.headers.hasOwnProperty(s))return e(o);const i=G[kt],a=G[yt],n=c=>typeof c=="string"&&c.length>0;return n(i)&&n(a)&&(r.headers[D]=a),e({...o,request:r})},St={step:"build",tags:["RECURSION_DETECTION"],name:"recursionDetectionMiddleware",override:!0,priority:"low"},Ot=t=>({applyToStack:e=>{e.add(wt(t),St)}}),At=void 0;function vt(t){return t===void 0?!0:typeof t=="string"&&t.length<=50}function Ft(t){const e=P(t.userAgentAppId??At),{customUserAgent:o}=t;return Object.assign(t,{customUserAgent:typeof o=="string"?[[o]]:o,userAgentAppId:async()=>{var s,i;const r=await e();if(!vt(r)){const a=((i=(s=t.logger)==null?void 0:s.constructor)==null?void 0:i.name)==="NoOpLogger"||!t.logger?console:t.logger;typeof r!="string"?a==null||a.warn("userAgentAppId must be a string or undefined."):r.length>50&&(a==null||a.warn("The provided userAgentAppId exceeds the maximum length of 50 characters."))}return r}})}const ce=(t,e=!1)=>{if(e){for(const o of t.split("."))if(!ce(o))return!1;return!0}return!(!Se(t)||t.length<3||t.length>63||t!==t.toLowerCase()||Oe(t))},W=":",Et="/",Pt=t=>{const e=t.split(W);if(e.length<6)return null;const[o,r,s,i,a,...n]=e;if(o!=="arn"||r===""||s===""||n.join(W)==="")return null;const c=n.map(u=>u.split(Et)).flat();return{partition:r,service:s,region:i,accountId:a,resourceId:c}},It=[{id:"aws",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-east-1",name:"aws",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^(us|eu|ap|sa|ca|me|af|il|mx)\\-\\w+\\-\\d+$",regions:{"af-south-1":{description:"Africa (Cape Town)"},"ap-east-1":{description:"Asia Pacific (Hong Kong)"},"ap-northeast-1":{description:"Asia Pacific (Tokyo)"},"ap-northeast-2":{description:"Asia Pacific (Seoul)"},"ap-northeast-3":{description:"Asia Pacific (Osaka)"},"ap-south-1":{description:"Asia Pacific (Mumbai)"},"ap-south-2":{description:"Asia Pacific (Hyderabad)"},"ap-southeast-1":{description:"Asia Pacific (Singapore)"},"ap-southeast-2":{description:"Asia Pacific (Sydney)"},"ap-southeast-3":{description:"Asia Pacific (Jakarta)"},"ap-southeast-4":{description:"Asia Pacific (Melbourne)"},"ap-southeast-5":{description:"Asia Pacific (Malaysia)"},"ap-southeast-7":{description:"Asia Pacific (Thailand)"},"aws-global":{description:"AWS Standard global region"},"ca-central-1":{description:"Canada (Central)"},"ca-west-1":{description:"Canada West (Calgary)"},"eu-central-1":{description:"Europe (Frankfurt)"},"eu-central-2":{description:"Europe (Zurich)"},"eu-north-1":{description:"Europe (Stockholm)"},"eu-south-1":{description:"Europe (Milan)"},"eu-south-2":{description:"Europe (Spain)"},"eu-west-1":{description:"Europe (Ireland)"},"eu-west-2":{description:"Europe (London)"},"eu-west-3":{description:"Europe (Paris)"},"il-central-1":{description:"Israel (Tel Aviv)"},"me-central-1":{description:"Middle East (UAE)"},"me-south-1":{description:"Middle East (Bahrain)"},"mx-central-1":{description:"Mexico (Central)"},"sa-east-1":{description:"South America (Sao Paulo)"},"us-east-1":{description:"US East (N. Virginia)"},"us-east-2":{description:"US East (Ohio)"},"us-west-1":{description:"US West (N. California)"},"us-west-2":{description:"US West (Oregon)"}}},{id:"aws-cn",outputs:{dnsSuffix:"amazonaws.com.cn",dualStackDnsSuffix:"api.amazonwebservices.com.cn",implicitGlobalRegion:"cn-northwest-1",name:"aws-cn",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^cn\\-\\w+\\-\\d+$",regions:{"aws-cn-global":{description:"AWS China global region"},"cn-north-1":{description:"China (Beijing)"},"cn-northwest-1":{description:"China (Ningxia)"}}},{id:"aws-us-gov",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-gov-west-1",name:"aws-us-gov",supportsDualStack:!0,supportsFIPS:!0},regionRegex:"^us\\-gov\\-\\w+\\-\\d+$",regions:{"aws-us-gov-global":{description:"AWS GovCloud (US) global region"},"us-gov-east-1":{description:"AWS GovCloud (US-East)"},"us-gov-west-1":{description:"AWS GovCloud (US-West)"}}},{id:"aws-iso",outputs:{dnsSuffix:"c2s.ic.gov",dualStackDnsSuffix:"c2s.ic.gov",implicitGlobalRegion:"us-iso-east-1",name:"aws-iso",supportsDualStack:!1,supportsFIPS:!0},regionRegex:"^us\\-iso\\-\\w+\\-\\d+$",regions:{"aws-iso-global":{description:"AWS ISO (US) global region"},"us-iso-east-1":{description:"US ISO East"},"us-iso-west-1":{description:"US ISO WEST"}}},{id:"aws-iso-b",outputs:{dnsSuffix:"sc2s.sgov.gov",dualStackDnsSuffix:"sc2s.sgov.gov",implicitGlobalRegion:"us-isob-east-1",name:"aws-iso-b",supportsDualStack:!1,supportsFIPS:!0},regionRegex:"^us\\-isob\\-\\w+\\-\\d+$",regions:{"aws-iso-b-global":{description:"AWS ISOB (US) global region"},"us-isob-east-1":{description:"US ISOB East (Ohio)"}}},{id:"aws-iso-e",outputs:{dnsSuffix:"cloud.adc-e.uk",dualStackDnsSuffix:"cloud.adc-e.uk",implicitGlobalRegion:"eu-isoe-west-1",name:"aws-iso-e",supportsDualStack:!1,supportsFIPS:!0},regionRegex:"^eu\\-isoe\\-\\w+\\-\\d+$",regions:{"aws-iso-e-global":{description:"AWS ISOE (Europe) global region"},"eu-isoe-west-1":{description:"EU ISOE West"}}},{id:"aws-iso-f",outputs:{dnsSuffix:"csp.hci.ic.gov",dualStackDnsSuffix:"csp.hci.ic.gov",implicitGlobalRegion:"us-isof-south-1",name:"aws-iso-f",supportsDualStack:!1,supportsFIPS:!0},regionRegex:"^us\\-isof\\-\\w+\\-\\d+$",regions:{"aws-iso-f-global":{description:"AWS ISOF global region"},"us-isof-east-1":{description:"US ISOF EAST"},"us-isof-south-1":{description:"US ISOF SOUTH"}}},{id:"aws-eusc",outputs:{dnsSuffix:"amazonaws.eu",dualStackDnsSuffix:"amazonaws.eu",implicitGlobalRegion:"eusc-de-east-1",name:"aws-eusc",supportsDualStack:!1,supportsFIPS:!0},regionRegex:"^eusc\\-(de)\\-\\w+\\-\\d+$",regions:{"eusc-de-east-1":{description:"EU (Germany)"}}}],bt={partitions:It};let Tt=bt;const _t=t=>{const{partitions:e}=Tt;for(const r of e){const{regions:s,outputs:i}=r;for(const[a,n]of Object.entries(s))if(a===t)return{...i,...n}}for(const r of e){const{regionRegex:s,outputs:i}=r;if(new RegExp(s).test(t))return{...i}}const o=e.find(r=>r.id==="aws");if(!o)throw new Error("Provided region was not found in the partition array or regex, and default partition with id 'aws' doesn't exist.");return{...o.outputs}},ue={isVirtualHostableS3Bucket:ce,parseArn:Pt,partition:_t};ie.aws=ue;function Rt(t,e,o){return t.$source||(t.$source={}),t.$source[e]=o,t}function y(t,e,o){t.__aws_sdk_context?t.__aws_sdk_context.features||(t.__aws_sdk_context.features={}):t.__aws_sdk_context={features:{}},t.__aws_sdk_context.features[e]=o}const j=t=>{var e,o;return Ae.isInstance(t)?((e=t.headers)==null?void 0:e.date)??((o=t.headers)==null?void 0:o.Date):void 0},le=t=>new Date(Date.now()+t),Ct=(t,e)=>Math.abs(le(e).getTime()-t)>=3e5,B=(t,e)=>{const o=Date.parse(t);return Ct(o,e)?o-Date.now():e},I=(t,e)=>{if(!e)throw new Error(`Property \`${t}\` is not resolved for AWS SDK SigV4Auth`);return e},Dt=async t=>{var u,l,d;const e=I("context",t.context),o=I("config",t.config),r=(d=(l=(u=e.endpointV2)==null?void 0:u.properties)==null?void 0:l.authSchemes)==null?void 0:d[0],i=await I("signer",o.signer)(r),a=t==null?void 0:t.signingRegion,n=t==null?void 0:t.signingRegionSet,c=t==null?void 0:t.signingName;return{config:o,signer:i,signingRegion:a,signingRegionSet:n,signingName:c}};class xt{async sign(e,o,r){var d;if(!C.isInstance(e))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const s=await Dt(r),{config:i,signer:a}=s;let{signingRegion:n,signingName:c}=s;const u=r.context;if(((d=u==null?void 0:u.authSchemes)==null?void 0:d.length)??!1){const[g,f]=u.authSchemes;(g==null?void 0:g.name)==="sigv4a"&&(f==null?void 0:f.name)==="sigv4"&&(n=(f==null?void 0:f.signingRegion)??n,c=(f==null?void 0:f.signingName)??c)}return await a.sign(e,{signingDate:le(i.systemClockOffset),signingRegion:n,signingService:c})}errorHandler(e){return o=>{const r=o.ServerTime??j(o.$response);if(r){const s=I("config",e.config),i=s.systemClockOffset;s.systemClockOffset=B(r,s.systemClockOffset),s.systemClockOffset!==i&&o.$metadata&&(o.$metadata.clockSkewCorrected=!0)}throw o}}successHandler(e,o){const r=j(e);if(r){const s=I("config",o.config);s.systemClockOffset=B(r,s.systemClockOffset)}}}const Lt=t=>{let e=t.credentials,o=!!t.credentials,r;Object.defineProperty(t,"credentials",{set(u){u&&u!==e&&u!==r&&(o=!0),e=u;const l=Ut(t,{credentials:e,credentialDefaultProvider:t.credentialDefaultProvider}),d=Mt(t,l);o&&!d.attributed?(r=async g=>d(g).then(f=>Rt(f,"CREDENTIALS_CODE","e")),r.memoized=d.memoized,r.configBound=d.configBound,r.attributed=!0):r=d},get(){return r},enumerable:!0,configurable:!0}),t.credentials=e;const{signingEscapePath:s=!0,systemClockOffset:i=t.systemClockOffset||0,sha256:a}=t;let n;return t.signer?n=P(t.signer):t.regionInfoProvider?n=()=>P(t.region)().then(async u=>[await t.regionInfoProvider(u,{useFipsEndpoint:await t.useFipsEndpoint(),useDualstackEndpoint:await t.useDualstackEndpoint()})||{},u]).then(([u,l])=>{const{signingRegion:d,signingService:g}=u;t.signingRegion=t.signingRegion||d||l,t.signingName=t.signingName||g||t.serviceId;const f={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},O=t.signerConstructor||z;return new O(f)}):n=async u=>{u=Object.assign({},{name:"sigv4",signingName:t.signingName||t.defaultSigningName,signingRegion:await P(t.region)(),properties:{}},u);const l=u.signingRegion,d=u.signingName;t.signingRegion=t.signingRegion||l,t.signingName=t.signingName||d||t.serviceId;const g={...t,credentials:t.credentials,region:t.signingRegion,service:t.signingName,sha256:a,uriEscapePath:s},f=t.signerConstructor||z;return new f(g)},Object.assign(t,{systemClockOffset:i,signingEscapePath:s,signer:n})};function Ut(t,{credentials:e,credentialDefaultProvider:o}){let r;return e?e!=null&&e.memoized?r=e:r=ve(e,Ee,Fe):o?r=P(o(Object.assign({},t,{parentClientConfig:t}))):r=async()=>{throw new Error("@aws-sdk/core::resolveAwsSdkSigV4Config - `credentials` not provided and no credentialDefaultProvider was configured.")},r.memoized=!0,r}function Mt(t,e){if(e.configBound)return e;const o=async r=>e({...r,callerClientConfig:t});return o.memoized=e.memoized,o.configBound=!0,o}const Nt=/\d{12}\.ddb/;async function $t(t,e,o){var i,a,n,c,u,l,d;const r=o.request;if(((i=r==null?void 0:r.headers)==null?void 0:i["smithy-protocol"])==="rpc-v2-cbor"&&y(t,"PROTOCOL_RPC_V2_CBOR","M"),typeof e.retryStrategy=="function"){const g=await e.retryStrategy();typeof g.acquireInitialRetryToken=="function"?(n=(a=g.constructor)==null?void 0:a.name)!=null&&n.includes("Adaptive")?y(t,"RETRY_MODE_ADAPTIVE","F"):y(t,"RETRY_MODE_STANDARD","E"):y(t,"RETRY_MODE_LEGACY","D")}if(typeof e.accountIdEndpointMode=="function"){const g=t.endpointV2;switch(String((c=g==null?void 0:g.url)==null?void 0:c.hostname).match(Nt)&&y(t,"ACCOUNT_ID_ENDPOINT","O"),await((u=e.accountIdEndpointMode)==null?void 0:u.call(e))){case"disabled":y(t,"ACCOUNT_ID_MODE_DISABLED","Q");break;case"preferred":y(t,"ACCOUNT_ID_MODE_PREFERRED","P");break;case"required":y(t,"ACCOUNT_ID_MODE_REQUIRED","R");break}}const s=(d=(l=t.__smithy_context)==null?void 0:l.selectedHttpAuthScheme)==null?void 0:d.identity;if(s!=null&&s.$source){const g=s;g.accountId&&y(t,"RESOLVED_ACCOUNT_ID","T");for(const[f,O]of Object.entries(g.$source??{}))y(t,f,O)}}const V="user-agent",x="x-amz-user-agent",q=" ",L="/",Ht=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w]/g,zt=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w\#]/g,K="-",Gt=1024;function Wt(t){let e="";for(const o in t){const r=t[o];if(e.length+r.length+1<=Gt){e.length?e+=","+r:e+=r;continue}break}return e}const jt=t=>(e,o)=>async r=>{var f,O,T,H;const{request:s}=r;if(!C.isInstance(s))return e(r);const{headers:i}=s,a=((f=o==null?void 0:o.userAgent)==null?void 0:f.map(_))||[],n=(await t.defaultUserAgentProvider()).map(_);await $t(o,t,r);const c=o;n.push(`m/${Wt(Object.assign({},(O=o.__smithy_context)==null?void 0:O.features,(T=c.__aws_sdk_context)==null?void 0:T.features))}`);const u=((H=t==null?void 0:t.customUserAgent)==null?void 0:H.map(_))||[],l=await t.userAgentAppId();l&&n.push(_([`app/${l}`]));const d=[].concat([...n,...a,...u]).join(q),g=[...n.filter(ke=>ke.startsWith("aws-sdk-")),...u].join(q);return t.runtime!=="browser"?(g&&(i[x]=i[x]?`${i[V]} ${g}`:g),i[V]=d):i[x]=d,e({...r,request:s})},_=t=>{var a;const e=t[0].split(L).map(n=>n.replace(Ht,K)).join(L),o=(a=t[1])==null?void 0:a.replace(zt,K),r=e.indexOf(L),s=e.substring(0,r);let i=e.substring(r+1);return s==="api"&&(i=i.toLowerCase()),[s,i,o].filter(n=>n&&n.length>0).reduce((n,c,u)=>{switch(u){case 0:return c;case 1:return`${n}/${c}`;default:return`${n}#${c}`}},"")},Bt={name:"getUserAgentMiddleware",step:"build",priority:"low",tags:["SET_USER_AGENT","USER_AGENT"],override:!0},Vt=t=>({applyToStack:e=>{e.add(jt(t),Bt)}}),qt=async(t,e,o)=>({operation:Pe(e).operation,region:await ae(t.region)()||(()=>{throw new Error("expected `region` to be configured for `aws.auth#sigv4`")})()});function Kt(t){return{schemeId:"aws.auth#sigv4",signingProperties:{name:"cognito-identity",region:t.region},propertiesExtractor:(e,o)=>({signingProperties:{config:e,context:o}})}}function R(t){return{schemeId:"smithy.api#noAuth"}}const Jt=t=>{const e=[];switch(t.operation){case"GetCredentialsForIdentity":{e.push(R());break}case"GetId":{e.push(R());break}case"GetOpenIdToken":{e.push(R());break}case"UnlinkIdentity":{e.push(R());break}default:e.push(Kt(t))}return e},Xt=t=>{const e=Lt(t);return Object.assign(e,{authSchemePreference:ae(t.authSchemePreference??[])})},Yt=t=>Object.assign(t,{useDualstackEndpoint:t.useDualstackEndpoint??!1,useFipsEndpoint:t.useFipsEndpoint??!1,defaultSigningName:"cognito-identity"}),Zt="3.826.0",Qt={version:Zt},eo=({serviceId:t,clientVersion:e})=>async o=>{var a,n,c,u,l,d;const r=typeof window<"u"&&((a=window==null?void 0:window.navigator)!=null&&a.userAgent)?Ie.parse(window.navigator.userAgent):void 0,s=[["aws-sdk-js",e],["ua","2.1"],[`os/${((n=r==null?void 0:r.os)==null?void 0:n.name)||"other"}`,(c=r==null?void 0:r.os)==null?void 0:c.version],["lang/js"],["md/browser",`${((u=r==null?void 0:r.browser)==null?void 0:u.name)??"unknown"}_${((l=r==null?void 0:r.browser)==null?void 0:l.version)??"unknown"}`]];t&&s.push([`api/${t}`,e]);const i=await((d=o==null?void 0:o.userAgentAppId)==null?void 0:d.call(o));return i&&s.push([`app/${i}`]),s},de="required",m="fn",k="argv",v="ref",J=!0,X="isSet",b="booleanEquals",A="error",w="endpoint",S="tree",N="PartitionResult",$="getAttr",F="stringEquals",Y={[de]:!1,type:"String"},Z={[de]:!0,default:!1,type:"Boolean"},Q={[v]:"Endpoint"},ge={[m]:b,[k]:[{[v]:"UseFIPS"},!0]},he={[m]:b,[k]:[{[v]:"UseDualStack"},!0]},p={},E={[v]:"Region"},ee={[m]:$,[k]:[{[v]:N},"supportsFIPS"]},fe={[v]:N},te={[m]:b,[k]:[!0,{[m]:$,[k]:[fe,"supportsDualStack"]}]},oe=[ge],re=[he],se=[E],to={parameters:{Region:Y,UseDualStack:Z,UseFIPS:Z,Endpoint:Y},rules:[{conditions:[{[m]:X,[k]:[Q]}],rules:[{conditions:oe,error:"Invalid Configuration: FIPS and custom endpoint are not supported",type:A},{conditions:re,error:"Invalid Configuration: Dualstack and custom endpoint are not supported",type:A},{endpoint:{url:Q,properties:p,headers:p},type:w}],type:S},{conditions:[{[m]:X,[k]:se}],rules:[{conditions:[{[m]:"aws.partition",[k]:se,assign:N}],rules:[{conditions:[ge,he],rules:[{conditions:[{[m]:b,[k]:[J,ee]},te],rules:[{conditions:[{[m]:F,[k]:[E,"us-east-1"]}],endpoint:{url:"https://cognito-identity-fips.us-east-1.amazonaws.com",properties:p,headers:p},type:w},{conditions:[{[m]:F,[k]:[E,"us-east-2"]}],endpoint:{url:"https://cognito-identity-fips.us-east-2.amazonaws.com",properties:p,headers:p},type:w},{conditions:[{[m]:F,[k]:[E,"us-west-1"]}],endpoint:{url:"https://cognito-identity-fips.us-west-1.amazonaws.com",properties:p,headers:p},type:w},{conditions:[{[m]:F,[k]:[E,"us-west-2"]}],endpoint:{url:"https://cognito-identity-fips.us-west-2.amazonaws.com",properties:p,headers:p},type:w},{endpoint:{url:"https://cognito-identity-fips.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:p,headers:p},type:w}],type:S},{error:"FIPS and DualStack are enabled, but this partition does not support one or both",type:A}],type:S},{conditions:oe,rules:[{conditions:[{[m]:b,[k]:[ee,J]}],rules:[{endpoint:{url:"https://cognito-identity-fips.{Region}.{PartitionResult#dnsSuffix}",properties:p,headers:p},type:w}],type:S},{error:"FIPS is enabled but this partition does not support FIPS",type:A}],type:S},{conditions:re,rules:[{conditions:[te],rules:[{conditions:[{[m]:F,[k]:["aws",{[m]:$,[k]:[fe,"name"]}]}],endpoint:{url:"https://cognito-identity.{Region}.amazonaws.com",properties:p,headers:p},type:w},{endpoint:{url:"https://cognito-identity.{Region}.{PartitionResult#dualStackDnsSuffix}",properties:p,headers:p},type:w}],type:S},{error:"DualStack is enabled but this partition does not support DualStack",type:A}],type:S},{endpoint:{url:"https://cognito-identity.{Region}.{PartitionResult#dnsSuffix}",properties:p,headers:p},type:w}],type:S}],type:S},{error:"Invalid Configuration: Missing Region",type:A}]},oo=to,ro=new be({size:50,params:["Endpoint","Region","UseDualStack","UseFIPS"]}),so=(t,e={})=>ro.get(t,()=>Te(oo,{endpointParams:t,logger:e.logger}));ie.aws=ue;const no=t=>({apiVersion:"2014-06-30",base64Decoder:(t==null?void 0:t.base64Decoder)??Ue,base64Encoder:(t==null?void 0:t.base64Encoder)??Le,disableHostPrefix:(t==null?void 0:t.disableHostPrefix)??!1,endpointProvider:(t==null?void 0:t.endpointProvider)??so,extensions:(t==null?void 0:t.extensions)??[],httpAuthSchemeProvider:(t==null?void 0:t.httpAuthSchemeProvider)??Jt,httpAuthSchemes:(t==null?void 0:t.httpAuthSchemes)??[{schemeId:"aws.auth#sigv4",identityProvider:e=>e.getIdentityProvider("aws.auth#sigv4"),signer:new xt},{schemeId:"smithy.api#noAuth",identityProvider:e=>e.getIdentityProvider("smithy.api#noAuth")||(async()=>({})),signer:new xe}],logger:(t==null?void 0:t.logger)??new De,serviceId:(t==null?void 0:t.serviceId)??"Cognito Identity",urlParser:(t==null?void 0:t.urlParser)??Ce,utf8Decoder:(t==null?void 0:t.utf8Decoder)??Re,utf8Encoder:(t==null?void 0:t.utf8Encoder)??_e}),io=t=>{const e=Me(t),o=()=>e().then(qe),r=no(t);return{...r,...t,runtime:"browser",defaultsMode:e,bodyLengthChecker:(t==null?void 0:t.bodyLengthChecker)??je,credentialDefaultProvider:(t==null?void 0:t.credentialDefaultProvider)??(s=>()=>Promise.reject(new Error("Credential is missing"))),defaultUserAgentProvider:(t==null?void 0:t.defaultUserAgentProvider)??eo({serviceId:r.serviceId,clientVersion:Qt.version}),maxAttempts:(t==null?void 0:t.maxAttempts)??We,region:(t==null?void 0:t.region)??Ge("Region is missing"),requestHandler:ze.create((t==null?void 0:t.requestHandler)??o),retryMode:(t==null?void 0:t.retryMode)??(async()=>(await o()).retryMode||He),sha256:(t==null?void 0:t.sha256)??$e,streamCollector:(t==null?void 0:t.streamCollector)??Ne,useDualstackEndpoint:(t==null?void 0:t.useDualstackEndpoint)??(()=>Promise.resolve(Ve)),useFipsEndpoint:(t==null?void 0:t.useFipsEndpoint)??(()=>Promise.resolve(Be))}},ao=t=>({setRegion(e){t.region=e},region(){return t.region}}),co=t=>({region:t.region()}),uo=t=>{const e=t.httpAuthSchemes;let o=t.httpAuthSchemeProvider,r=t.credentials;return{setHttpAuthScheme(s){const i=e.findIndex(a=>a.schemeId===s.schemeId);i===-1?e.push(s):e.splice(i,1,s)},httpAuthSchemes(){return e},setHttpAuthSchemeProvider(s){o=s},httpAuthSchemeProvider(){return o},setCredentials(s){r=s},credentials(){return r}}},lo=t=>({httpAuthSchemes:t.httpAuthSchemes(),httpAuthSchemeProvider:t.httpAuthSchemeProvider(),credentials:t.credentials()}),go=(t,e)=>{const o=Object.assign(ao(t),Ke(t),Je(t),uo(t));return e.forEach(r=>r.configure(o)),Object.assign(t,co(o),Xe(o),Ye(o),lo(o))};class ho extends Ze{constructor(...[o]){const r=io(o||{});super(r);h(this,"config");this.initConfig=r;const s=Yt(r),i=Ft(s),a=Qe(i),n=et(a),c=n,u=tt(c),l=Xt(u),d=go(l,(o==null?void 0:o.extensions)||[]);this.config=d,this.middlewareStack.use(Vt(this.config)),this.middlewareStack.use(ot(this.config)),this.middlewareStack.use(rt(this.config)),this.middlewareStack.use(ht(this.config)),this.middlewareStack.use(mt(this.config)),this.middlewareStack.use(Ot(this.config)),this.middlewareStack.use(st(this.config,{httpAuthSchemeParametersProvider:qt,identityProviderConfigProvider:async g=>new it({"aws.auth#sigv4":g.credentials})})),this.middlewareStack.use(nt(this.config))}destroy(){super.destroy()}}var pe=(t=>(t.Succeeded="succeeded",t.Failed="failed",t))(pe||{}),M=(t=>(t.DialogMessageReceived="dialogMessageReceived",t.DialogEventReceived="dialogEventReceived",t))(M||{});class me{constructor(e){h(this,"logger");this.logger=e}async launchWebAuthFlow(e){return this.logger.warn("launchWebAuthFlow using basic window.open approach in Outlook context",{sourceFile:"src/platforms/outlook/OutlookIdentityProvider.ts",sourceFunction:"launchWebAuthFlow"}),this.initiateOAuth(e.url,"")}async initiateOAuth(e,o){var r;try{const s=window.Office;return(r=s==null?void 0:s.ui)!=null&&r.displayDialogAsync?(this.logger.info("Using Office.ui.displayDialogAsync for OAuth",{sourceFile:"src/platforms/outlook/OutlookIdentityProvider.ts",sourceFunction:"initiateOAuth"}),new Promise((i,a)=>{s.ui.displayDialogAsync(e,{height:60,width:60},n=>{var c;if(n.status===pe.Succeeded){const u=n.value;u.addEventHandler(M.DialogMessageReceived,l=>{u.close(),i(l.message||"")}),u.addEventHandler(M.DialogEventReceived,l=>{u.close(),l.error===12006?a(new Error("Authentication was cancelled by user")):a(new Error(`Authentication dialog failed with error: ${l.error}`))})}else a(new Error(`Failed to open authentication dialog: ${((c=n.error)==null?void 0:c.message)||"Unknown error"}`))})})):(this.logger.warn("Office.ui not available, using window.open fallback",{sourceFile:"src/platforms/outlook/OutlookIdentityProvider.ts",sourceFunction:"initiateOAuth"}),new Promise((i,a)=>{const n=window.open(e,"_blank","width=500,height=600,scrollbars=yes,resizable=yes");if(!n){a(new Error("Failed to open authentication window. Please check popup blockers."));return}const c=setInterval(()=>{try{if(n.closed){clearInterval(c),a(new Error("Authentication was cancelled by user"));return}try{const u=n.location.href;if(u&&u.includes("access_token=")){clearInterval(c),n.close(),i(u);return}}catch{}}catch{clearInterval(c),n==null||n.close(),a(new Error("Error during authentication process"))}},1e3);setTimeout(()=>{clearInterval(c),n.closed||n.close(),a(new Error("Authentication timeout - please try again"))},3e5)}))}catch(s){throw this.logger.error("Error initiating OAuth",s,{sourceFile:"src/platforms/outlook/OutlookIdentityProvider.ts",sourceFunction:"initiateOAuth"}),s}}}const fo="https://localhost:3000/auth-dialog.html",U="https://localhost:3000/api/auth/status";async function po(){return new Promise((t,e)=>{let o=null,r=!1;const s=async()=>{try{console.log("Checking auth status...");const i=await fetch(U,{method:"GET",credentials:"include"});if(i.ok){const a=await i.json();if(console.log("Auth status check response:",a),a.isAuthenticated&&a.accessToken&&!r){r=!0,o&&clearInterval(o);const n={access_token:a.accessToken,refresh_token:a.refreshToken,id_token:a.idToken,expires_in:a.expiresIn,token_type:a.tokenType,fetched_at:Math.floor(Date.now()/1e3)};t(n)}}}catch(i){console.log("Auth status check failed:",i)}};Office.context.ui.displayDialogAsync(fo,{height:70,width:50,promptBeforeOpen:!1},i=>{if(i.status!==Office.AsyncResultStatus.Succeeded)return e(new Error(i.error.message));const a=i.value;o=setInterval(s,2e3),s(),a.addEventHandler(Office.EventType.DialogMessageReceived,async n=>{try{if("message"in n){let c;if(typeof n.message=="string")c=JSON.parse(n.message);else if(typeof n.message=="object")c=n.message;else{console.log("Unknown message type:",typeof n.message,n.message);return}c.type==="AUTH_SUCCESS"?(console.log("Received AUTH_SUCCESS message from dialog"),await s(),a.close()):c.type==="AUTH_ERROR"&&(console.log("Received AUTH_ERROR message from dialog:",c.error),r||(r=!0,o&&clearInterval(o),a.close(),e(new Error(c.error))))}}catch(c){console.log("Error handling dialog message:",c)}}),a.addEventHandler(Office.EventType.DialogEventReceived,async n=>{if(console.log("Dialog event received:",n),"error"in n&&n.error===12006&&!r){console.log("Dialog cancelled, performing final auth status check...");try{const u=await fetch(U,{method:"GET",credentials:"include"});if(u.ok){const l=await u.json();if(l.isAuthenticated&&l.accessToken){console.log("Authentication was successful despite cancellation"),r=!0,o&&clearInterval(o);const d={access_token:l.accessToken,refresh_token:l.refreshToken,id_token:l.idToken,expires_in:l.expiresIn,token_type:l.tokenType,fetched_at:Math.floor(Date.now()/1e3)};t(d);return}}}catch(u){console.log("Final auth status check failed:",u)}r=!0,o&&clearInterval(o),e(new Error("Authentication cancelled by user"))}}),setTimeout(async()=>{if(!r){console.log("Authentication timeout reached, performing final auth status check...");try{const n=await fetch(U,{method:"GET",credentials:"include"});if(n.ok){const c=await n.json();if(c.isAuthenticated&&c.accessToken){console.log("Authentication was successful despite timeout"),r=!0,o&&clearInterval(o),a.close();const u={access_token:c.accessToken,refresh_token:c.refreshToken,id_token:c.idToken,expires_in:c.expiresIn,token_type:c.tokenType,fetched_at:Math.floor(Date.now()/1e3)};t(u);return}}}catch(n){console.log("Final auth status check on timeout failed:",n)}r=!0,o&&clearInterval(o),a.close(),e(new Error("Authentication timeout"))}},5*60*1e3)})})}const mo="us-east-1";class ko{constructor(e){h(this,"logger");h(this,"authListeners",new Set);h(this,"cachedToken",null);h(this,"cognitoClient");h(this,"identityProvider");this.logger=e,this.cognitoClient=new ho({region:mo}),this.identityProvider=new me(e)}async login(){try{const e=await po();return this.logger.info("Token received",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"login",tokens:e}),this.cachedToken=e,await this.saveToken(e),this.notifyAuthListeners(!0),e}catch(e){throw this.logger.error("Login failed",e,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"login"}),e}}async OldLogin(){try{let e;try{e=await this.getOfficeAccessToken(),this.logger.info("Successfully obtained Office SSO token",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"login"})}catch(r){this.logger.warn("Office SSO failed, falling back to OAuth flow",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"login",error:r}),e=await this.fallbackOAuthLogin()}const o=await this.exchangeOfficeTokenForCognito(e);return this.cachedToken=o,await this.saveToken(o),this.notifyAuthListeners(!0),o}catch(e){throw this.logger.error("Login failed",e,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"login"}),e}}async logout(){this.cachedToken=null,await this.deleteToken(),this.notifyAuthListeners(!1)}async getToken(){if(this.cachedToken)return this.cachedToken;const e=await this.loadTokenFromStorage();return e?(this.cachedToken=e,e):null}onAuthStateChanged(e){this.authListeners.add(e)}removeAuthStateListener(e){this.authListeners.delete(e)}notifyAuthListeners(e){this.authListeners.forEach(o=>o(e))}async isAuthenticated(){const e=await this.getToken();return e?this.isTokenValid(e):!1}async getOfficeAccessToken(){var r,s,i,a;if(typeof Office>"u")throw new Error("Office.js is not loaded. Make sure the add-in is running in an Office context.");if(!Office.context)throw new Error("Office context is not available. The add-in may not be properly initialized.");const e=Office;if((r=e.auth)!=null&&r.getAccessToken)try{return this.logger.info("Using Office.auth.getAccessToken",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),await e.auth.getAccessToken({allowSignInPrompt:!0,allowConsentPrompt:!0,forMSGraphAccess:!0})}catch(n){throw this.logger.error("Office.auth.getAccessToken failed",n,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),new Error(`Office SSO failed: ${n instanceof Error?n.message:"Unknown error"}`)}if(typeof OfficeRuntime<"u"&&OfficeRuntime.auth&&typeof OfficeRuntime.auth.getAccessToken=="function")try{return this.logger.info("Using OfficeRuntime.auth.getAccessToken",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),await OfficeRuntime.auth.getAccessToken({allowSignInPrompt:!0,allowConsentPrompt:!0,forMSGraphAccess:!0})}catch(n){throw this.logger.error("OfficeRuntime.auth.getAccessToken failed",n,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),new Error(`Office SSO failed: ${n instanceof Error?n.message:"Unknown error"}`)}const o=Office.context;if((s=o.auth)!=null&&s.getAccessTokenAsync)try{return this.logger.info("Using Office.context.auth.getAccessTokenAsync",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),await new Promise((n,c)=>{o.auth.getAccessTokenAsync({allowSignInPrompt:!0,allowConsentPrompt:!0,forMSGraphAccess:!0},u=>{var l;u.status===Office.AsyncResultStatus.Succeeded?n(u.value):c(new Error(((l=u.error)==null?void 0:l.message)||"Unknown error"))})})}catch(n){throw this.logger.error("Office.context.auth.getAccessTokenAsync failed",n,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken"}),new Error(`Office SSO failed: ${n instanceof Error?n.message:"Unknown error"}`)}throw this.logger.warn("Office SSO APIs not available",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"getOfficeAccessToken",officeVersion:(a=(i=Office.context)==null?void 0:i.requirements)!=null&&a.isSetSupported("IdentityAPI","1.3")?"Modern":"Legacy",hasContext:!!Office.context,hasOfficeAuth:!!e.auth,hasOfficeRuntimeAuth:!!(typeof OfficeRuntime<"u"&&OfficeRuntime.auth),hasContextAuth:!!o.auth,contextKeys:Office.context?Object.keys(Office.context):[]}),new Error("Office SSO is not supported in this environment. Please ensure you are running in a supported Office application with SSO enabled.")}async exchangeOfficeTokenForCognito(e){try{return this.logger.info("Using Cognito User Pool token directly",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"exchangeOfficeTokenForCognito"}),{id_token:e,access_token:e,refresh_token:"",expires_in:3600,token_type:"Bearer",fetched_at:Math.floor(Date.now()/1e3)}}catch(o){throw this.logger.error("Token processing failed",o,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"exchangeOfficeTokenForCognito"}),o}}async validateToken(e){const o=await this.getToken();return o?this.isTokenValid(o):!1}isTokenValid(e){if(!e||!e.expires_in)return!1;const o=Math.floor(Date.now()/1e3);return!(e.expires_in+(e.fetched_at||0)-o<60)}async refreshToken(e){return this.logger.info("Refreshing token",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"refreshToken"}),this.login()}async saveToken(e){typeof localStorage<"u"&&localStorage.setItem("candle_auth_token",JSON.stringify(e))}async loadTokenFromStorage(){if(typeof localStorage>"u")return null;try{const e=localStorage.getItem("candle_auth_token");return e?JSON.parse(e):null}catch(e){return this.logger.warn("Failed to load token from storage",{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"loadTokenFromStorage",error:e}),null}}async deleteToken(){typeof localStorage<"u"&&localStorage.removeItem("candle_auth_token")}async fallbackOAuthLogin(){var o,r;const e=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${at}&response_type=token&redirect_uri=${encodeURIComponent(ct)}&scope=${encodeURIComponent("https://graph.microsoft.com/.default")}&response_mode=fragment`;try{const s=await((r=(o=this.identityProvider).launchWebAuthFlow)==null?void 0:r.call(o,{url:e,interactive:!0}));if(!s)throw new Error("OAuth flow did not return a result");const i=this.parseAccessTokenFromOAuthResponse(s);if(!i)throw new Error("Failed to extract access token from OAuth response");return i}catch(s){throw this.logger.error("OAuth fallback failed",s,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"fallbackOAuthLogin"}),new Error("Both Office SSO and OAuth fallback failed. Please check your authentication configuration.")}}parseAccessTokenFromOAuthResponse(e){try{let o=e;e.includes("#")&&(o=e.split("#")[1]);const r=new URLSearchParams(o),s=r.get("access_token");if(!s)return this.logger.error("No access_token found in OAuth response",new Error("Missing access token"),{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"parseAccessTokenFromOAuthResponse",responseUrl:e,fragment:o}),null;const i=r.get("error");if(i){const a=r.get("error_description")||"Unknown OAuth error";throw new Error(`OAuth error: ${i} - ${a}`)}return s}catch(o){return this.logger.error("Failed to parse OAuth response",o,{sourceFile:"OutlookAuthProvider.ts",sourceFunction:"parseAccessTokenFromOAuthResponse",responseUrl:e}),null}}}class yo{constructor(e){h(this,"logger");this.logger=e}async sendMessage(e){return this.logger.debug("Sending message in Outlook context",{sourceFile:"src/platforms/outlook/OutlookMessagingProvider.ts",sourceFunction:"sendMessage",message:e}),Promise.resolve(e)}onMessage(e){this.logger.debug("Registering message callback in Outlook context",{sourceFile:"src/platforms/outlook/OutlookMessagingProvider.ts",sourceFunction:"onMessage"})}removeMessageListener(e){this.logger.debug("Removing message listener in Outlook context",{sourceFile:"src/platforms/outlook/OutlookMessagingProvider.ts",sourceFunction:"removeMessageListener"})}async sendOfficeNotification(e){try{typeof Office<"u"&&Office.context&&Office.context.ui&&Office.context.ui.displayDialogAsync(`data:text/html,<html><body><p>${e}</p></body></html>`,{height:20,width:40},o=>{o.status===Office.AsyncResultStatus.Succeeded&&setTimeout(()=>o.value.close(),3e3)})}catch(o){this.logger.error("Error showing Office notification",o,{sourceFile:"src/platforms/outlook/OutlookMessagingProvider.ts",sourceFunction:"sendOfficeNotification"})}}}class wo{constructor(e){h(this,"logger");h(this,"eventListeners",new Map);h(this,"isInitialized",!1);this.logger=e}async initialize(){if(this.isInitialized){this.logger.info("Outlook platform already initialized",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"initialize"});return}try{this.logger.info("Initializing Outlook platform...",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"initialize"}),await this.waitForOfficeReady(),this.setupOutlookEventListeners(),this.isInitialized=!0,this.logger.info("Outlook platform initialized successfully",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"initialize"})}catch(e){throw this.logger.error("Failed to initialize Outlook platform",e,{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"initialize"}),e}}async cleanup(){try{this.logger.info("Cleaning up Outlook platform...",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"cleanup"}),this.eventListeners.clear(),this.isInitialized=!1,this.logger.info("Outlook platform cleanup completed",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"cleanup"})}catch(e){throw this.logger.error("Failed to cleanup Outlook platform",e,{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"cleanup"}),e}}async closeWindow(){this.logger.debug("Window close requested (no-op for Outlook)",{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"closeWindow"})}onPlatformEvent(e,o){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(o)}async waitForOfficeReady(){return new Promise(e=>{typeof Office<"u"&&Office.onReady?Office.onReady(()=>{e()}):e()})}setupOutlookEventListeners(){var e;typeof Office<"u"&&Office.context&&(e=Office.context.mailbox)!=null&&e.addHandlerAsync&&Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged,this.handleItemChanged.bind(this),o=>{o.status===Office.AsyncResultStatus.Failed&&this.logger.error("Failed to add item changed handler",o.error,{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"setupOutlookEventListeners"})})}handleItemChanged(){this.emitPlatformEvent("itemChanged")}emitPlatformEvent(e,...o){const r=this.eventListeners.get(e);r&&r.forEach(s=>{try{s(...o)}catch(i){this.logger.error(`Error in platform event callback for ${e}`,i,{sourceFile:"src/platforms/outlook/OutlookLifecycleProvider.ts",sourceFunction:"emitPlatformEvent",event:e})}})}}class So{constructor(e){h(this,"logger");this.logger=e}async getCurrentTab(){return this.logger.debug("getCurrentTab called in Outlook context",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"getCurrentTab"}),{id:1,windowId:1,index:0,url:window.location.href,title:document.title||"Outlook Add-in",active:!0,highlighted:!0,pinned:!1,incognito:!1}}async createTab(e,o){return this.logger.debug("createTab called in Outlook context",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"createTab",url:e}),window.open(e,"_blank"),{id:Date.now(),windowId:1,index:0,url:e,title:"New Tab",active:!0,highlighted:!0,pinned:!1,incognito:!1}}async updateTab(e,o){this.logger.debug("updateTab called in Outlook context - this is a no-op",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"updateTab"})}async closeTab(e){this.logger.debug("closeTab called in Outlook context - this is a no-op",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"closeTab"})}onTabUpdated(e){this.logger.debug("onTabUpdated called in Outlook context - this is a no-op",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"onTabUpdated"})}removeTabUpdateListener(e){this.logger.debug("removeTabUpdateListener called in Outlook context - this is a no-op",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"removeTabUpdateListener"})}async openURL(e,o="_blank"){this.logger.debug("openURL called in Outlook context",{sourceFile:"src/platforms/outlook/OutlookTabsProvider.ts",sourceFunction:"openURL",url:e,target:o}),window.open(e,o)}}class Oo{constructor(e){h(this,"logger");this.logger=e}async executeScript(e){throw this.logger.warn("Script execution not implemented for Outlook context",{sourceFile:"src/platforms/outlook/OutlookContentScriptProvider.ts",sourceFunction:"executeScript"}),new Error("Script execution not available in Outlook context")}async injectScript(e){this.logger.warn("Script injection not applicable in Outlook context",{sourceFile:"src/platforms/outlook/OutlookContentScriptProvider.ts",sourceFunction:"injectScript"})}async insertContentIntoComposeBox(e){var o;try{typeof Office<"u"&&Office.context&&Office.context.mailbox?(o=Office.context.mailbox.item)==null||o.body.setAsync(e,{coercionType:Office.CoercionType.Html},r=>{r.status===Office.AsyncResultStatus.Failed&&this.logger.error("Failed to insert content into compose box",r.error,{sourceFile:"src/platforms/outlook/OutlookContentScriptProvider.ts",sourceFunction:"insertContentIntoComposeBox"})}):this.logger.warn("Office.js context not available",{sourceFile:"src/platforms/outlook/OutlookContentScriptProvider.ts",sourceFunction:"insertContentIntoComposeBox"})}catch(r){throw this.logger.error("Error inserting content into compose box",r,{sourceFile:"src/platforms/outlook/OutlookContentScriptProvider.ts",sourceFunction:"insertContentIntoComposeBox"}),r}}}const ne={ERROR:1,WARN:2,INFO:3,DEBUG:4};class Ao{constructor(e){h(this,"context");h(this,"minLevel");this.context=e||"unknown",this.minLevel="WARN"}shouldLog(e){return ne[e]<=ne[this.minLevel]}formatMessage(e,o,r){const s=(r==null?void 0:r.sourceFile)||"unknown",i=r==null?void 0:r.sourceFunction;return`[${e}] [Outlook:${this.context}] [${s}${i?` (${i})`:""}]: ${o}`}async debug(e,o){if(!this.shouldLog("DEBUG"))return;const r=this.formatMessage("DEBUG",e,o),{sourceFile:s,sourceFunction:i,...a}=o||{},n=[r];Object.keys(a).length>0&&n.push(a),console.debug(...n)}async info(e,o){if(!this.shouldLog("INFO"))return;const r=this.formatMessage("INFO",e,o),{sourceFile:s,sourceFunction:i,...a}=o||{},n=[r];Object.keys(a).length>0&&n.push(a),console.info(...n)}async warn(e,o){if(!this.shouldLog("WARN"))return;const r=this.formatMessage("WARN",e,o),{sourceFile:s,sourceFunction:i,...a}=o||{},n=[r];Object.keys(a).length>0&&n.push(a),console.warn(...n)}async error(e,o,r){if(!this.shouldLog("ERROR"))return;const s=this.formatMessage("ERROR",e,r),{sourceFile:i,sourceFunction:a,...n}=r||{},c=[s];o&&c.push(o),Object.keys(n).length>0&&c.push(n),console.error(...c)}setMinLevel(e){this.minLevel=e}getMinLevel(){return this.minLevel}getUnderlyingLogger(){return{context:this.context,minLevel:this.minLevel,writeLog:async(e,o,r,s)=>{switch(e){case"DEBUG":return this.debug(o,r);case"INFO":return this.info(o,r);case"WARN":return this.warn(o,r);case"ERROR":return this.error(o,s,r)}},_triggerCleanupCheck:()=>{},debug:(e,o)=>this.debug(e,o),info:(e,o)=>this.info(e,o),warn:(e,o)=>this.warn(e,o),error:(e,o,r)=>this.error(e,o,r)}}}function Po(){const t=new Ao("background");return{storage:new ut(t),data:new lt(t),auth:new ko(t),messaging:new yo(t),lifecycle:new wo(t),tabs:new So(t),contentScript:new Oo(t),identity:new me(t),logging:t}}export{ko as OutlookAuthProvider,Oo as OutlookContentScriptProvider,lt as OutlookDataProvider,me as OutlookIdentityProvider,wo as OutlookLifecycleProvider,yo as OutlookMessagingProvider,ut as OutlookStorageProvider,So as OutlookTabsProvider,Po as createOutlookServices};
